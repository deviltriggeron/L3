<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Warehouse Control</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2rem;
        }

        input,
        button {
            margin: 0.2rem;
        }

        table {
            border-collapse: collapse;
            margin-top: 1rem;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 0.5rem;
            text-align: left;
        }

        #current-user {
            font-weight: bold;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <h1>Warehouse Control</h1>

    <section id="login-section">
        <h2>Login</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <p id="login-msg"></p>
    </section>

    <div id="current-user" style="display:none;">
        Logged in as: <span id="user-info"></span>
        <button onclick="logout()">Logout</button>
    </div>

    <section id="items-section" style="display:none;">
        <h2>Items</h2>

        <button onclick="fetchItems()">Refresh Items</button>
        <table id="items-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Description</th>
                    <th>Count</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>Add Item</h3>
        <div id="add-item-form">
            <input type="text" id="item-product" placeholder="Product">
            <input type="number" id="item-price" placeholder="Price">
            <input type="text" id="item-desc" placeholder="Description">
            <input type="number" id="item-count" placeholder="Count">
            <button onclick="addItem()">Add Item</button>
        </div>
        <p id="item-msg"></p>

        <h3>Get Item by ID</h3>
        <input type="text" id="get-item-id" placeholder="Enter item ID">
        <button onclick="getItem()">Get Item</button>
        <div id="get-item-result"></div>

        <div id="history-section" style="display:none; margin-top:2rem;">
            <h3>Items History</h3>
            <button onclick="loadHistory()">Load History</button>
            <table id="history-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Item ID</th>
                        <th>Action</th>
                        <th>Changed By</th>
                        <th>Changed At</th>
                        <th>Old Data</th>
                        <th>New Data</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </section>

    <script>
        let token = "";
        let currentUserRole = "";

        async function login() {
            const user = document.getElementById("username").value;
            const pass = document.getElementById("password").value;

            const res = await fetch("/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user, password: pass })
            });

            const data = await res.json();

            if (res.ok) {
                token = data.token;
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUserRole = payload.role;

                document.getElementById("login-section").style.display = "none";
                document.getElementById("items-section").style.display = "block";
                document.getElementById("current-user").style.display = "block";
                document.getElementById("user-info").textContent = `${payload.username} (${payload.role})`;

                if (currentUserRole !== "admin") {
                    document.getElementById("add-item-form").style.display = "none";
                } else {
                    document.getElementById("add-item-form").style.display = "block";
                }

                if (currentUserRole === "admin" || currentUserRole === "manager") {
                    document.getElementById("history-section").style.display = "block";
                }

                fetchItems();
            } else {
                document.getElementById("login-msg").textContent = data.error || "Login failed!";
            }
        }

        function logout() {
            token = "";
            currentUserRole = "";
            document.getElementById("login-section").style.display = "block";
            document.getElementById("items-section").style.display = "none";
            document.getElementById("current-user").style.display = "none";
            document.getElementById("login-msg").textContent = "";
            document.getElementById("item-msg").textContent = "";
            document.getElementById("get-item-result").textContent = "";
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
            document.getElementById("history-section").style.display = "none";
        }

        async function fetchItems() {
            const res = await fetch("/api/items", {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!res.ok) {
                document.getElementById("item-msg").textContent = "Failed to fetch items";
                return;
            }

            const items = await res.json();
            const tbody = document.querySelector("#items-table tbody");
            tbody.innerHTML = "";

            items.forEach(item => {
                const tr = document.createElement("tr");
                const actions = [];

                if (currentUserRole === "admin" || currentUserRole === "manager") {
                    actions.push(`<button onclick="updateItem('${item.ID}')">Update</button>`);
                }
                if (currentUserRole === "admin") {
                    actions.push(`<button onclick="deleteItem('${item.ID}')">Delete</button>`);
                }

                tr.innerHTML = `
          <td>${item.ID}</td>
          <td><input type="text" value="${item.Product}" id="product-${item.ID}" ${currentUserRole === "viewer" ? "disabled" : ""}></td>
          <td><input type="number" value="${item.Price}" id="price-${item.ID}" ${currentUserRole === "viewer" ? "disabled" : ""}></td>
          <td><input type="text" value="${item.Description}" id="desc-${item.ID}" ${currentUserRole === "viewer" ? "disabled" : ""}></td>
          <td><input type="number" value="${item.Count}" id="count-${item.ID}" ${currentUserRole === "viewer" ? "disabled" : ""}></td>
          <td>${actions.join(" ")}</td>
        `;
                tbody.appendChild(tr);
            });
        }

        async function addItem() {
            const product = document.getElementById("item-product").value;
            const price = parseFloat(document.getElementById("item-price").value);
            const desc = document.getElementById("item-desc").value;
            const count = parseInt(document.getElementById("item-count").value, 10);

            const res = await fetch("/api/items", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ product, price, description: desc, count })
            });

            if (res.ok) {
                document.getElementById("item-msg").textContent = "Item added!";
                fetchItems();
            } else {
                const err = await res.text();
                document.getElementById("item-msg").textContent = `Error: ${err}`;
            }
        }

        async function updateItem(id) {
            const product = document.getElementById(`product-${id}`).value;
            const price = parseFloat(document.getElementById(`price-${id}`).value);
            const desc = document.getElementById(`desc-${id}`).value;
            const count = parseInt(document.getElementById(`count-${id}`).value, 10);

            const res = await fetch(`/api/items/${id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ product, price, description: desc, count })
            });

            if (res.ok) {
                document.getElementById("item-msg").textContent = "Item updated!";
                fetchItems();
            } else {
                const err = await res.text();
                document.getElementById("item-msg").textContent = `Error: ${err}`;
            }
        }

        async function deleteItem(id) {
            if (!confirm("Are you sure you want to delete this item?")) return;

            const res = await fetch(`/api/items/${id}`, {
                method: "DELETE",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (res.ok) {
                document.getElementById("item-msg").textContent = "Item deleted!";
                fetchItems();
            } else {
                const err = await res.text();
                document.getElementById("item-msg").textContent = `Error: ${err}`;
            }
        }

        async function getItem() {
            const id = document.getElementById("get-item-id").value;
            if (!id) {
                document.getElementById("get-item-result").textContent = "Please enter an ID";
                return;
            }

            const res = await fetch(`/api/items/${id}`, {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (res.ok) {
                const item = await res.json();
                document.getElementById("get-item-result").innerHTML = `
          <pre>${JSON.stringify(item, null, 2)}</pre>
        `;
            } else {
                const err = await res.text();
                document.getElementById("get-item-result").textContent = `Error: ${err}`;
            }
        }

        async function loadHistory() {
            const res = await fetch("/api/history", {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!res.ok) {
                alert("Failed to load history");
                return;
            }

            const history = await res.json();
            const tbody = document.querySelector("#history-table tbody");
            tbody.innerHTML = "";

            history.forEach(h => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${h.ID}</td>
          <td>${h.ItemID}</td>
          <td>${h.Action}</td>
          <td>${h.ChangedBy}</td>
          <td>${new Date(h.ChangedAt).toLocaleString()}</td>
          <td><pre>${JSON.stringify(h.OldData || {}, null, 2)}</pre></td>
          <td><pre>${JSON.stringify(h.NewData || {}, null, 2)}</pre></td>
        `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>

</html>